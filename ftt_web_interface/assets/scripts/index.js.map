{"version":3,"file":"index.js","sources":["webpack:///index.js"],"sourcesContent":["!function(e){var t={};function s(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,\"a\",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p=\"assets/scripts/\",s(s.s=6)}([function(e,t,s){\"use strict\";s.d(t,\"a\",(function(){return a}));class a{static clearChildren(e){e.innerHTML=\"\"}static addOption(e,t,s=null){let a=document.createElement(\"option\");a.value=t,a.innerText=t,s&&a.classList.add(s),e.appendChild(a)}static removeFirstEmptyOption(e){\"\"===e.firstChild.value&&e.removeChild(e.firstChild)}static populateSelect(e,t,s=null){a.clearChildren(e),a.addOption(e,\"\");for(let n=0;n<t.length;n++)a.addOption(e,t[n],s&&s[n])}static addRow(e,t){const s=e.insertRow(0);for(const e of t){const t=s.insertCell(),a=document.createTextNode(e);t.appendChild(a)}}static populateTable(e,t){a.clearChildren(e);for(const s of t.reverse())a.addRow(e,s)}static addImage(e,t,s,...a){let n=document.createElement(\"img\");if(n.src=t,n.alt=s,a){if(a.length<2||a.length%2!=0)return e.appendChild(n),-1;for(let e=0;e<a.length;e+=2)n[a[e]]=a[e+1]}e.appendChild(n)}static createMaterialIcon(e){const t=document.createElement(\"i\");return t.className=\"material-icons\",t.textContent=e,t.style.alignSelf=\"center\",\"clear\"===e?t.style.color=\"red\":\"done\"===e&&(t.style.color=\"green\"),t}static createMaterialIconsContainer(e,t,s=null){const n=document.createElement(e);return n.className=\"icon-container\",t.forEach((e,t)=>{const i=a.createMaterialIcon(e);s&&\"function\"==typeof s[t]&&i.addEventListener(\"click\",s[t]),n.appendChild(i)}),n}}},function(e,t,s){\"use strict\";s.d(t,\"a\",(function(){return a})),s.d(t,\"b\",(function(){return n}));class a{constructor(e,t,s){this.id=e,this.name=t,this.institution=s}}class n{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"name\",\"institution\"]}async get(){return(await this.serverInterface.sendGetRequest(\"personnel\")).map(e=>new a(e[0],e[1],e[2]))}async post(e,t){const s={[this.paramNames[1]]:e,[this.paramNames[2]]:t};await this.serverInterface.sendPostRequest(\"personnel\",s)}async put(e,t,s){const a={[this.paramNames[0]]:e};Object.assign(a,null!==t&&{[this.paramNames[1]]:t},null!==s&&{[this.paramNames[2]]:s}),await this.serverInterface.sendPutRequest(\"personnel\",a)}async delete(e){await this.serverInterface.sendDeleteRequest(\"personnel\",\"id=\"+e)}}},function(e,t,s){\"use strict\";s.d(t,\"a\",(function(){return a}));class a{constructor(){this.server_adr=location.host}async sendHttpRequest(e,t,s){const a=await fetch(t,{method:e,body:JSON.stringify(s),headers:{\"Content-Type\":\"application/json\"}});if(a.status>=200&&a.status<300)return a.json();{const e=await a.json();throw console.log(e.message),new Error(\"Something went wrong! Server message: \"+e.message)}}async sendGetRequest(e,t){const s=await this.sendHttpRequest(\"GET\",`http://${this.server_adr}/${e}${t?\"?\"+t:\"\"}`);if(s)return s;throw new Error(\"Empty HTTP response!\")}async sendPostRequest(e,t){const s=await this.sendHttpRequest(\"POST\",`http://${this.server_adr}/${e}`,t);if(s)return console.log(s),s;throw new Error(\"Invalid HTTP request\")}async sendPutRequest(e,t){const s=await this.sendHttpRequest(\"PUT\",`http://${this.server_adr}/${e}`,t);if(!s)throw new Error(\"Invalid HTTP request\");console.log(s)}async sendDeleteRequest(e,t){const s=await this.sendHttpRequest(\"DELETE\",`http://${this.server_adr}/${e}${t?\"?\"+t:\"\"}`);if(!s)throw new Error(\"Invalid HTTP request\");console.log(s)}}},function(e,t,s){\"use strict\";s.d(t,\"a\",(function(){return n}));class a{constructor(e,t){this.id=e,this.institution=t}}class n{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"institution\"]}async get(){return(await this.serverInterface.sendGetRequest(\"performer\")).map(e=>new a(e[0],e[1]))}async post(e){const t={[this.paramNames[1]]:e};await this.serverInterface.sendPostRequest(\"performer\",t)}async put(e,t){const s={[this.paramNames[0]]:e};Object.assign(s,null!==t&&{[this.paramNames[1]]:t}),await this.serverInterface.sendPutRequest(\"performer\",s)}async delete(e){await this.serverInterface.sendDeleteRequest(\"performer\",\"id=\"+e)}}},function(e,t,s){\"use strict\";s.d(t,\"a\",(function(){return n}));class a{constructor(e,t,s,a,n,i){this.id=e,this.key=t,this.shortDescription=s,this.longDescription=a,this.institution=n,this.configuration=i}}class n{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"key\",\"short_description\",\"long_description\",\"institution\",\"configuration\"]}async get(){return(await this.serverInterface.sendGetRequest(\"vehicle\")).map(e=>new a(e[0],e[1],e[2],e[3],e[4],e[5]))}async post(e,t,s,a,n){const i={[this.paramNames[1]]:e,[this.paramNames[2]]:t,[this.paramNames[3]]:s,[this.paramNames[4]]:a,[this.paramNames[5]]:n};await this.serverInterface.sendPostRequest(\"vehicle\",i)}async put(e,t,s,a,n,i){const r={[this.paramNames[0]]:e};Object.assign(r,null!==t&&{[this.paramNames[1]]:t},null!==s&&{[this.paramNames[2]]:s},null!==a&&{[this.paramNames[3]]:a},null!==n&&{[this.paramNames[4]]:n},null!==i&&{[this.paramNames[5]]:i}),await this.serverInterface.sendPutRequest(\"vehicle\",r)}async delete(e){await this.serverInterface.sendDeleteRequest(\"vehicle\",\"id=\"+e)}}},function(e,t,s){\"use strict\";s.d(t,\"a\",(function(){return n}));class a{constructor(e,t,s,a){this.id=e,this.key=t,this.shortDescription=s,this.longDescription=a}}class n{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"key\",\"short_description\",\"long_description\"]}async get(){return(await this.serverInterface.sendGetRequest(\"pose_source\")).map(e=>new a(e[0],e[1],e[2],e[3]))}async post(e,t,s){const a={[this.paramNames[1]]:e,[this.paramNames[2]]:t,[this.paramNames[3]]:s};await this.serverInterface.sendPostRequest(\"pose_source\",a)}async put(e,t,s,a){const n={[this.paramNames[0]]:e};Object.assign(n,null!==t&&{[this.paramNames[1]]:t},null!==s&&{[this.paramNames[2]]:s},null!==a&&{[this.paramNames[3]]:a}),await this.serverInterface.sendPutRequest(\"pose_source\",n)}async delete(e){await this.serverInterface.sendDeleteRequest(\"pose_source\",\"id=\"+e)}}},function(e,t,s){\"use strict\";s.r(t);var a=s(2);class n{constructor(e){this.serverInterface=e,this.paramNames=[\"segment_id\",\"lat\",\"lng\",\"pose_source_id\",\"orig_secs\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"pose\",\"segment_id=\"+e))[0]}async post(e,t,s,a){const n={[this.paramNames[0]]:e,[this.paramNames[1]]:t,[this.paramNames[2]]:s,[this.paramNames[3]]:a,[this.paramNames[4]]:(new Date).getTime()/1e3};await this.serverInterface.sendPostRequest(\"pose\",n)}}class i{constructor(e,t,s,a,n,i,r,l,o,c,d){this.id=e,this.shiftId=t,this.secs=s,this.frameId=a,this.width=n,this.height=i,this.resolution=r,this.originX=l,this.originY=o,this.imageData=c,this.origSecs=d}}class r{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"shift_id\",\"secs\",\"frame_id\",\"width\",\"height\",\"resolution\",\"origin_x\",\"origin_y\",\"image_data\",\"orig_secs\"]}async get(e){const t=await this.serverInterface.sendGetRequest(\"map_image\",\"shift_id=\"+e);return new i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],\"data:image/jpeg;base64, \"+atob(t[9]),t[10])}}class l{constructor(e){this.poseInterface=new n(e),this.mapImageInterface=new r(e),this.mapPointsLayers=[],this.activeMarker=null,this.activePoses=null,this.leafletMap=L.map(\"gps-map\"),this.changeTileLayer(),this.localMapOverlay=null,this.layerControl=null,this.mapImage=null,this.mapElementContainer=document.getElementById(\"map-viewer\"),this.mapElement=document.getElementById(\"gps-map\")}changeTileLayer(){let e=JSON.parse(localStorage.getItem(\"fttTileServerData\"));e||(e={url:\"https://a.tile.openstreetmap.org/{z}/{x}/{y}.png\",minZoom:0,maxZoom:19},localStorage.setItem(\"fttTileServerData\",JSON.stringify(e))),L.tileLayer(e.url,{minZoom:e.minZoom,maxZoom:e.maxZoom}).addTo(this.leafletMap),e.url.indexOf(\"openstreetmap\")>-1?this.leafletMap.attributionControl.addAttribution('&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'):this.leafletMap.attributionControl.removeAttribution('&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors')}async addLocalMap(e,t){if(this.localMapOverlay&&this.mapImage.width===e.width&&this.mapImage.height===e.height&&this.mapImage.resolution===e.resolution)return void(this.localMapOverlay._rawImage.src=e.imageData);if(t.length<2)return;const s=new Image;s.src=e.imageData;const a=(t[1].lat+t[0].lat)/2*(Math.PI/180),n=111132.92-559.82*Math.cos(2*a)+1.175*Math.cos(4*a)-.0023*Math.cos(6*a),i=111412.84*Math.cos(a)-93.5*Math.cos(3*a)+.118*Math.cos(5*a),r=Math.atan2((t[1].lat-t[0].lat)*n,(t[1].lng-t[0].lng)*i)-Math.atan2(t[1].local_y-t[0].local_y,t[1].local_x-t[0].local_x),l=e.originX,o=e.originY,c=e.originX,d=e.originY+e.height*e.resolution,h=e.originX+e.width*e.resolution,m=e.originY+e.height*e.resolution,u=(l-t[0].local_x)*Math.cos(r)-(o-t[0].local_y)*Math.sin(r),p=(l-t[0].local_x)*Math.sin(r)+(o-t[0].local_y)*Math.cos(r),g=(c-t[0].local_x)*Math.cos(r)-(d-t[0].local_y)*Math.sin(r),v=(c-t[0].local_x)*Math.sin(r)+(d-t[0].local_y)*Math.cos(r),f=(h-t[0].local_x)*Math.cos(r)-(m-t[0].local_y)*Math.sin(r),y=(h-t[0].local_x)*Math.sin(r)+(m-t[0].local_y)*Math.cos(r),I=L.latLng(t[0].lat+p/n,t[0].lng+u/i),w=L.latLng(t[0].lat+v/n,t[0].lng+g/i),b=L.latLng(t[0].lat+y/n,t[0].lng+f/i);let E=!1;this.localMapOverlay&&(E=this.leafletMap.hasLayer(this.localMapOverlay),this.removeLocalMap()),this.localMapOverlay=L.imageOverlay.rotated(s,w,b,I,{opacity:.4,interactive:!0}),E&&this.localMapOverlay.addTo(this.leafletMap),this.layerControl||(this.layerControl=L.control.layers().addTo(this.leafletMap)),this.layerControl.addOverlay(this.localMapOverlay,\"Local Map\"),this.mapImage=e}removeLocalMap(){this.localMapOverlay&&(this.leafletMap.removeLayer(this.localMapOverlay),this.layerControl.removeLayer(this.localMapOverlay),this.localMapOverlay=null,this.mapImage=null)}removeLayerControl(){this.layerControl&&(this.leafletMap.removeControl(this.layerControl),this.layerControl=null)}removePoses(e){const t=this.mapPointsLayers.findIndex(t=>t.segmentId==e);if(t>-1){const e=this.mapPointsLayers[t].mapPosesPtr;e==this.activePoses&&(this.activePoses=null),this.leafletMap.removeLayer(e),this.mapPointsLayers.splice(t,1)}}async getAndDrawMapPoses(e){try{const t=await this.poseInterface.get(e);if(this.removePoses(e),t.features){this.mapElementContainer.style.display=\"block\",this.leafletMap.invalidateSize(!0);let s={radius:2,weight:1,opacity:1,fillOpacity:.8};const a=L.geoJSON(t,{pointToLayer:function(e,t){return\"AUTO\"==e.properties.type?s.color=\"green\":s.color=\"red\",L.circleMarker(t,s)},onEachFeature:function(e,t){e.properties&&e.properties.segmentId&&t.bindPopup(\"<span>Segment \"+e.properties.segmentId+\"</span>\")}}).addTo(this.leafletMap);this.mapPointsLayers.push({segmentId:e,mapPosesPtr:a})}else console.log(\"No position data for segment \"+e)}catch(e){console.log(e.message)}}removeActiveMarker(){this.activeMarker&&(this.leafletMap.removeLayer(this.activeMarker),this.activeMarker=null)}removeActivePoses(){this.activePoses&&(this.activePoses.eachLayer(e=>{\"AUTO\"==e.feature.properties.type?e.setStyle({color:\"green\"}):e.setStyle({color:\"red\"})}),this.activePoses=null)}addActiveMarker(e,t){this.activeMarker=L.marker([e,t]).addTo(this.leafletMap),this.leafletMap.getZoom()?this.leafletMap.panTo([e,t]):console.log(\"Cannot pan Leaflet map before loading it.\")}addActivePoses(e){const t=this.mapPointsLayers.find(t=>t.segmentId==e);t&&(this.activePoses=t.mapPosesPtr,this.activePoses.setStyle({color:\"blue\"}))}}class o{constructor(e,t,s,a,n,i,r,l){this.id=e,this.segmentId=t,this.secs=s,this.frameId=a,this.x=n,this.y=i,this.type=r,this.origSecs=l}}class c{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"segment_id\",\"secs\",\"frame_id\",\"x\",\"y\",\"type\",\"orig_secs\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"local_pose\",\"segment_id=\"+e)).map(e=>new o(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]))}}class d{constructor(e){this.mapImageInterface=new r(e),this.localPoseInterface=new c(e),this.mapElement=document.getElementById(\"local-map\"),this.zoomInBtn=document.getElementById(\"local-map-zoom-in-btn\"),this.zoomOutBtn=document.getElementById(\"local-map-zoom-out-btn\"),this.mapPointsLayers=[],this.activeMarker=null,this.activePoses=null,this.mapBitmap=null,this.viewer=new ROS2D.Viewer({divID:\"local-map\",width:560,height:560}),this.viewer.scene.addChild(new createjs.Shape),this.zoomView=new ROS2D.ZoomView({rootObject:this.viewer.scene}),this.panView=new ROS2D.PanView({rootObject:this.viewer.scene}),createjs.Touch.enable(this.viewer.scene),this.mouseDown=!1,this.viewer.scene.addEventListener(\"stagemousedown\",e=>{this.panView.startPan(e.stageX,e.stageY),this.mouseDown=!0}),this.viewer.scene.addEventListener(\"stagemousemove\",e=>{!0===this.mouseDown&&this.panView.pan(e.stageX,e.stageY)}),this.viewer.scene.addEventListener(\"stagemouseup\",()=>{!0===this.mouseDown&&(this.mouseDown=!1)}),this.viewer.scene.canvas.addEventListener(\"wheel\",this.zoomMapHandler.bind(this,0)),this.zoomInBtn.addEventListener(\"click\",this.zoomMapHandler.bind(this,50)),this.zoomOutBtn.addEventListener(\"click\",this.zoomMapHandler.bind(this,-50)),createjs.Ticker.addEventListener(\"tick\",this.viewer.scene),createjs.Ticker.on(\"tick\",e=>{if(\"block\"==this.mapElement.style.display){const t=this.viewer.scene.canvas.width,s=this.viewer.scene.canvas.height,a=parseInt(getComputedStyle(this.mapElement).width),n=parseInt(getComputedStyle(this.mapElement).height);this.viewer.scene.canvas.width=a,this.viewer.scene.canvas.height=n,this.mapBitmap&&this.viewer.shift((t-a)/2/this.viewer.scene.scaleX,(n-s)/2/this.viewer.scene.scaleY),this.viewer.scene.update(e)}})}zoomMapHandler(e,t){let s,a;if(t.preventDefault(),t.stopPropagation(),\"wheel\"===t.type){const n=t.target.getBoundingClientRect();s=t.clientX-n.left,a=t.clientY-n.top,e=-t.deltaY}else{if(\"click\"!==t.type)return void console.log(\"zoomMapHandler triggered by unexpected event. Aborting.\");s=this.viewer.scene.canvas.width/2,a=this.viewer.scene.canvas.height/2}this.zoomView.startZoom(s,a);const n=1+e/this.viewer.scene.canvas.clientHeight;this.zoomView.zoom(n)}resetViewer(){this.viewer.scene.removeAllChildren(),this.viewer.scene.addChild(new createjs.Shape),this.mapBitmap&&(this.mapBitmap=null),this.viewer.scene.x=0,this.viewer.scene.x_prev_shift=this.viewer.scene.x,this.viewer.scene.y=this.viewer.height,this.viewer.scene.y_prev_shift=this.viewer.scene.y}async getAndDrawMap(e){try{const t=await this.mapImageInterface.get(e),s=!this.mapBitmap;if(this.mapOrigin={x:t.originX,y:t.originY},this.mapBitmap=new createjs.Bitmap(t.imageData),this.mapBitmap.x=t.originX,this.mapBitmap.y=-t.height*t.resolution-t.originY,this.mapBitmap.scaleX=t.resolution,this.mapBitmap.scaleY=t.resolution,this.viewer.scene.removeChildAt(0),this.viewer.scene.addChildAt(this.mapBitmap,0),s){this.viewer.scene.addChildAt(this.mapBitmap,0);const e=this.viewer.width/this.viewer.height;t.width>t.height?this.viewer.scaleToDimensions(t.width*t.resolution,t.width*t.resolution/e):this.viewer.scaleToDimensions(t.height*t.resolution*e,t.height*t.resolution),this.viewer.shift(t.originX-(this.viewer.scene.canvas.width-this.viewer.width)/2/this.viewer.scene.scaleX,t.originY+(this.viewer.scene.canvas.height-this.viewer.height)/2/this.viewer.scene.scaleY)}return t}catch(e){return console.log(e.message),null}}removePoses(e){const t=this.mapPointsLayers.findIndex(t=>t.segmentId==e);if(t>-1){const e=this.mapPointsLayers[t].mapPosesPtr;e==this.activePoses&&(this.activePoses=null),this.viewer.scene.removeChild(e.shape),this.mapPointsLayers.splice(t,1)}}async getAndDrawMapPoses(e){try{const t=await this.localPoseInterface.get(e);if(this.removePoses(e),t.length>0){const s=new createjs.Shape;let a;a=\"AUTO\"==t[0].type?\"green\":\"red\",s.graphics.setStrokeStyle(.2);const n=s.graphics.beginStroke(a).command;s.graphics.moveTo(t[0].x,-t[0].y),t.forEach(e=>{s.graphics.lineTo(e.x,-e.y)}),this.activeMarker&&this.viewer.scene.removeChild(this.activeMarker),this.viewer.scene.addChild(s),this.activeMarker&&this.viewer.scene.addChild(this.activeMarker),this.mapPointsLayers.push({segmentId:e,mapPosesPtr:{shape:s,command:n,type:t[0].type}})}else console.log(\"No local position data for segment \"+e)}catch(e){console.log(e.message)}}removeActiveMarker(){this.activeMarker&&(this.viewer.scene.removeChild(this.activeMarker),this.activeMarker=null)}removeActivePoses(){this.activePoses&&(this.activePoses.command.style=\"AUTO\"==this.activePoses.type?\"green\":\"red\",this.activePoses=null)}addActiveMarker(e,t){this.activeMarker=new createjs.Shape,this.activeMarker.graphics.beginFill(\"blue\").drawCircle(e,-t,.5),this.viewer.scene.addChild(this.activeMarker)}addActivePoses(e){const t=this.mapPointsLayers.find(t=>t.segmentId==e);t&&(this.activePoses=t.mapPosesPtr,this.activePoses.command.style=\"blue\")}}var h=s(0);class m{constructor(e,t,s){this.fallbackText=t,this.closeCallbackFunction=s,this.visible=!1;const a=document.getElementById(\"modal-template\"),n=document.importNode(a.content,!0);this.modalElement=n.querySelector(\".modal\"),this.modalElement.insertBefore(e.element,this.modalElement.children[0]),e.element=this.modalElement,this.modalElement.addEventListener(\"transitionend\",this.close.bind(this)),this.backdropElement=n.querySelector(\".backdrop\"),this.backdropElement.addEventListener(\"click\",this.hide.bind(this)),this.buttonElement=n.getElementById(\"modal-close-btn\"),this.buttonElement.addEventListener(\"click\",this.hide.bind(this))}show(){\"content\"in document.createElement(\"template\")?(document.body.insertAdjacentElement(\"afterbegin\",this.modalElement),document.body.insertAdjacentElement(\"afterbegin\",this.backdropElement),this.modalElement.scrollIntoView({behavior:\"smooth\"}),this.visible=!0,this.modalElement.classList.add(\"show\")):alert(this.fallbackText)}hide(){this.visible=!1,this.modalElement.classList.remove(\"show\")}close(){this.visible||(this.modalElement&&(document.body.removeChild(this.modalElement),document.body.removeChild(this.backdropElement),this.modalElement=null,this.backdropElement=null),this.closeCallbackFunction&&this.closeCallbackFunction())}}class u{constructor(e,t,s,a,n,i,r,l,o,c,d,h,m,u,p,g,v){this.id=e,this.legId=t,this.parentId=s,this.startTime=a,this.endTime=n,this.itoReasonId=i,this.itoReason=r,this.segmentTypeId=l,this.segmentType=o,this.obstacle=c,this.lighting=d,this.slope=h,this.lng=m,this.lat=u,this.local_x=p,this.local_y=g,this.origStartTime=v}}class p{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"leg_id\",\"parent_id\",\"starttime_secs\",\"endtime_secs\",\"ito_reason_id\",\"ito_reason\",\"segment_type_id\",\"segment_type\",\"obstacle\",\"lighting\",\"slope\",\"lng\",\"lat\",\"local_x\",\"local_y\",\"orig_starttime_secs\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"segment\",\"leg_id=\"+e)).map(e=>new u(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15],e[16]))}async post(e,t,s,a,n,i,r){const l={[this.paramNames[1]]:e,[this.paramNames[5]]:t,[this.paramNames[7]]:s,[this.paramNames[12]]:a,[this.paramNames[13]]:n,[this.paramNames[14]]:i,[this.paramNames[15]]:r,[this.paramNames[16]]:(new Date).getTime()/1e3};await this.serverInterface.sendPostRequest(\"segment\",l)}async put(e,t,s=null,a=null,n=null,i=null){const r={[this.paramNames[0]]:e,action:t};Object.assign(r,s&&{[this.paramNames[5]]:s},a&&{[this.paramNames[9]]:a},n&&{[this.paramNames[10]]:n},i&&{[this.paramNames[11]]:i}),await this.serverInterface.sendPutRequest(\"segment\",r)}}class g{constructor(e,t){this.id=e,this.shortDescription=t}}class v{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"short_description\"]}async get(){return(await this.serverInterface.sendGetRequest(\"ito_reason\")).map(e=>new g(e[0],e[1]))}}class f{constructor(e,t,s,a,n){this.id=e,this.segmentId=t,this.secs=s,this.personnelId=a,this.note=n}}class y{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"segment_id\",\"secs\",\"personnel_id\",\"note\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"note\",\"segment_id=\"+e)).map(e=>new f(e[0],e[1],e[2],e[3],e[4]))}async post(e,t,s){const a={[this.paramNames[1]]:e,[this.paramNames[3]]:t,[this.paramNames[4]]:s};await this.serverInterface.sendPostRequest(\"note\",a)}async put(e,t=null,s=null){const a={[this.paramNames[0]]:e};Object.assign(a,null!==t&&{[this.paramNames[3]]:t},null!==s&&{[this.paramNames[4]]:s}),await this.serverInterface.sendPutRequest(\"note\",a)}async delete(e){await this.serverInterface.sendDeleteRequest(\"note\",\"id=\"+e)}}class I{constructor(e,t,s,a,n,i,r){this.id=e,this.segmentId=t,this.secs=s,this.imageFilename=a,this.imageData=n,this.description=i,this.origSecs=r}}class w{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"segment_id\",\"secs\",\"image_filename\",\"image_data\",\"description\",\"orig_secs\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"image\",\"segment_id=\"+e)).map(e=>new I(e[0],e[1],e[2],e[3],\"data:image/jpeg;base64, \"+atob(e[4]),e[5],e[6]))}async post(e,t,s,a){const n={[this.paramNames[1]]:e,[this.paramNames[3]]:t,[this.paramNames[4]]:s,[this.paramNames[5]]:a,[this.paramNames[6]]:(new Date).getTime()/1e3};await this.serverInterface.sendPostRequest(\"image\",n)}async delete(e){await this.serverInterface.sendDeleteRequest(\"image\",\"id=\"+e)}}class b{constructor(e,t,s,a,n,i){this.segment=e,this.segmentInterface=t,this.noteInterface=s,this.imageInterface=a,this.itoReasonList=n,this.currentUser=i;const r=document.getElementById(\"edit-segment-template\");this.element=document.importNode(r.content,!0),this.element.querySelector(\"header h2 span:last-of-type\").textContent=e.id,this.element.querySelector(\"header p:first-of-type span:last-of-type\").textContent=new Date(1e3*e.startTime).toISOString(),e.endTime&&(this.element.querySelector(\"header p:last-of-type span:last-of-type\").textContent=new Date(1e3*e.endTime).toISOString());const l=this.element.getElementById(\"ito-reason\"),o=this.element.getElementById(\"obstacle\"),c=this.element.getElementById(\"lighting\"),d=this.element.getElementById(\"slope\");h.a.populateSelect(l,n.map(e=>e.shortDescription));const m=n.find(t=>t.id==e.itoReasonId);m&&(l.value=m.shortDescription,h.a.removeFirstEmptyOption(l)),o.value=e.obstacle,c.value=e.lighting,d.value=e.slope,\"ITO\"!=e.segmentType&&(l.disabled=!0,o.disabled=!0,c.disabled=!0,d.disabled=!0),l.addEventListener(\"change\",this.segmentDataChangedHandler.bind(this)),o.addEventListener(\"input\",this.segmentDataChangedHandler.bind(this)),c.addEventListener(\"input\",this.segmentDataChangedHandler.bind(this)),d.addEventListener(\"input\",this.segmentDataChangedHandler.bind(this)),this.element.querySelector(\"form button\").addEventListener(\"click\",this.updateDataBtnHandler.bind(this)),this.noteList=null,this.selectedNoteIdx=0,this.element.getElementById(\"note-text\").addEventListener(\"keydown\",this.noteTextChangeHandler.bind(this)),this.element.getElementById(\"save-note-btn\").addEventListener(\"click\",this.saveNoteButtonHandler.bind(this)),this.element.getElementById(\"remove-note-btn\").addEventListener(\"click\",this.removeNoteButtonHandler.bind(this));const u=this.element.querySelector(\".current-images\");this.imageList=null,this.newImage=null,this.newImageName=null,this.element.getElementById(\"current-images-tab\").addEventListener(\"click\",this.currentImagesTabClickHandler.bind(this)),this.element.getElementById(\"upload-image-tab\").addEventListener(\"click\",this.uploadImageTabClickHandler.bind(this)),u.addEventListener(\"focusin\",this.imageFocusHandler.bind(this)),u.addEventListener(\"focusout\",this.imageDefocusHandler.bind(this)),u.addEventListener(\"dblclick\",this.imageDoubleClickHandler.bind(this)),this.element.getElementById(\"new-image\").addEventListener(\"change\",this.newImageInputHandler.bind(this)),this.element.getElementById(\"submit-image-btn\").addEventListener(\"click\",this.submitImageBtnHandler.bind(this)),this.init()}async init(){await this.renderNotes(),await this.renderImages()}segmentDataChangedHandler(e){if(\"AUTO\"==this.segment.segmentType)return e.target.value=\"\",void alert(\"Obstacle context data available only for ITO segments!\");this.element.querySelector(\"#obstacle\").validity.patternMismatch||this.element.querySelector(\"#lighting\").validity.patternMismatch||this.element.querySelector(\"#slope\").validity.patternMismatch?(this.element.querySelector(\"form button\").disabled=!0,this.element.querySelector(\".info-text\").style.display=\"inline\"):(this.element.querySelector(\"form button\").disabled=!1,this.element.querySelector(\".info-text\").style.display=\"\")}async updateDataBtnHandler(e){e.preventDefault();const t=this.itoReasonList.find(e=>e.shortDescription==document.getElementById(\"ito-reason\").value).id,s=document.getElementById(\"obstacle\").value.replace(/[^\\x00-\\x7F]/g,\"\"),a=document.getElementById(\"lighting\").value.replace(/[^\\x00-\\x7F]/g,\"\"),n=document.getElementById(\"slope\").value.replace(/[^\\x00-\\x7F]/g,\"\");try{await this.segmentInterface.put(this.segment.id,\"edit\",t,s,a,n),this.element.querySelector(\"form button\").disabled=!0}catch(e){alert(e.message)}}async renderNotes(){try{this.noteList=await this.noteInterface.get(this.segment.id),h.a.clearChildren(this.element.querySelector(\".btn-tabs\")),this.noteList.forEach(e=>{this.createNewNoteTab(new Date(1e3*e.secs).toString().substring(4,10))}),this.createNewNoteTab(\"New Note\",\"\"),this.element.querySelector(\".btn-tabs\").children[this.selectedNoteIdx].click()}catch(e){alert(e.message)}}createNewNoteTab(e){const t=this.element.querySelector(\".btn-tabs\");Array.from(t.children).forEach(e=>{e.classList.remove(\"new-note\")});const s=document.createElement(\"button\");s.textContent=e,s.classList.add(\"new-note\"),t.appendChild(s),s.addEventListener(\"click\",this.noteTabClickHandler.bind(this))}noteTabClickHandler(e){const t=Array.from(this.element.querySelector(\".btn-tabs\").children);t.forEach(e=>{e.classList.remove(\"selected-tab\"),\"*\"==e.textContent.slice(-1)&&(e.textContent=e.textContent.slice(0,-1)),this.element.querySelector(\"#save-note-btn\").disabled=!0}),e.target.classList.add(\"selected-tab\"),this.selectedNoteIdx=t.indexOf(e.target);const s=this.element.querySelector(\"#note-text\");this.selectedNoteIdx<this.noteList.length?(s.value=this.noteList[this.selectedNoteIdx].note,this.element.querySelector(\"#remove-note-btn\").disabled=!1):(s.value=\"\",this.element.querySelector(\"#remove-note-btn\").disabled=!0)}noteTextChangeHandler(){let e=this.element.querySelector(\".selected-tab\");\"*\"!=e.textContent.slice(-1)&&(e.textContent+=\"*\"),document.getElementById(\"save-note-btn\").disabled=!1}async saveNoteButtonHandler(e){if(e.preventDefault(),!this.currentUser.id)return void alert(\"Please select a user to add or modify a note!\");const t=document.getElementById(\"note-text\").value.replace(/[^\\x00-\\x7F]/g,\"\");try{this.selectedNoteIdx<this.noteList.length?await this.noteInterface.put(this.noteList[this.selectedNoteIdx].id,this.currentUser.id,t):await this.noteInterface.post(this.segment.id,this.currentUser.id,t),e.target.disabled=!0,await this.renderNotes()}catch(e){alert(e.message)}}async removeNoteButtonHandler(){try{await this.noteInterface.delete(this.noteList[this.selectedNoteIdx].id),await this.renderNotes()}catch(e){alert(e.message)}}async renderImages(){try{this.imageList=await this.imageInterface.get(this.segment.parentId||this.segment.id);const e=this.element.querySelector(\".current-images\");h.a.clearChildren(e),this.imageList.forEach(t=>{const s=document.createElement(\"div\");s.tabIndex=0,h.a.addImage(s,t.imageData,t.imageFilename),e.appendChild(s)})}catch(e){alert(e.message)}}async currentImagesTabClickHandler(e){e.target.classList.contains(\"selected-tab\")||(e.target.nextElementSibling.classList.remove(\"selected-tab\"),e.target.classList.add(\"selected-tab\"),this.element.querySelector(\".upload-image\").style.display=\"none\",this.element.querySelector(\".current-images\").style.display=\"\",this.renderImages())}uploadImageTabClickHandler(e){e.target.classList.contains(\"selected-tab\")||(this.currentUser.id?(e.target.previousElementSibling.classList.remove(\"selected-tab\"),e.target.classList.add(\"selected-tab\"),this.element.querySelector(\".current-images\").style.display=\"none\",this.element.querySelector(\".upload-image\").style.display=\"block\"):alert(\"Please select a user to add an image!\"))}async removeImageBtnClickHandler(e){const t=Array.from(this.element.querySelector(\".current-images\").children).indexOf(e.target.closest(\"div\"));try{await this.imageInterface.delete(this.imageList[t].id),this.renderImages()}catch(e){alert(e.message)}}imageFocusHandler(e){const t=h.a.createMaterialIconsContainer(\"span\",[\"remove_circle_outline\"]);t.addEventListener(\"click\",this.removeImageBtnClickHandler.bind(this)),e.target.appendChild(t)}imageDefocusHandler(e){e.target.lastElementChild.remove()}imageDoubleClickHandler(e){if(\"img\"===e.target.tagName.toLowerCase()){const t=open(\"\");t.document.write(e.target.outerHTML),t.document.head.appendChild(document.head.querySelector(\"meta\")),t.document.head.appendChild(document.createElement(\"title\")),t.document.head.querySelector(\"title\").textContent=e.target.alt}}newImageInputHandler(e){const t=e.target.files[0];if(this.newImageName=t.name.replace(/[.][^.]+$/,\"\"),t){const e=new FileReader;e.readAsDataURL(t),e.addEventListener(\"load\",e=>{this.newImage=e.target.result,this.newImage=this.newImage.substring(this.newImage.indexOf(\",\")+1)}),document.getElementById(\"submit-image-btn\").disabled=!1}}async submitImageBtnHandler(e){if(e.preventDefault(),this.newImage)try{await this.imageInterface.post(this.segment.parentId||this.segment.id,this.newImageName,this.newImage,\"Image uploaded by \"+this.currentUser.name),this.newImage=null,e.target.disabled=!0,document.getElementById(\"current-images-tab\").click()}catch(e){alert(e.message)}}}class E{constructor(){const e=document.getElementById(\"map-config-template\");this.element=document.importNode(e.content,!0);const t=this.element.getElementById(\"map-url\"),s=this.element.getElementById(\"map-min-zoom\"),a=this.element.getElementById(\"map-max-zoom\"),n=JSON.parse(localStorage.getItem(\"fttTileServerData\"));n?(t.value=n.url,s.value=n.minZoom,a.value=n.maxZoom):alert(\"No map configuration data in local storage.\"),t.addEventListener(\"input\",this.dataChangedHandler.bind(this)),s.addEventListener(\"input\",this.dataChangedHandler.bind(this)),a.addEventListener(\"input\",this.dataChangedHandler.bind(this)),this.element.querySelector(\"form button:first-of-type\").addEventListener(\"click\",this.updateDataBtnHandler.bind(this)),this.element.querySelector(\"form button:last-of-type\").addEventListener(\"click\",this.resetDataBtnHandler.bind(this))}dataChangedHandler(){this.element.querySelector(\"form button\").disabled=!1}async updateDataBtnHandler(e){e.preventDefault();let t={};t.url=document.getElementById(\"map-url\").value,t.minZoom=document.getElementById(\"map-min-zoom\").value,t.maxZoom=document.getElementById(\"map-max-zoom\").value,localStorage.setItem(\"fttTileServerData\",JSON.stringify(t)),this.element.querySelector(\"form button\").disabled=!0}async resetDataBtnHandler(e){e.preventDefault();const t={url:\"https://a.tile.openstreetmap.org/{z}/{x}/{y}.png\",minZoom:0,maxZoom:19};document.getElementById(\"map-url\").value=t.url,document.getElementById(\"map-min-zoom\").value=t.minZoom,document.getElementById(\"map-max-zoom\").value=t.maxZoom,localStorage.setItem(\"fttTileServerData\",JSON.stringify(t)),this.element.querySelector(\"form button\").disabled=!0}}class C{constructor(e,t){this.serverInterface=e,this.currentUser=t,this.legSelectHook=document.getElementById(\"leg-id\"),this.unexpectedBtn=document.getElementById(\"unexpected-btn\"),this.plannerBtn=document.getElementById(\"planner-btn\"),this.safetyBtn=document.getElementById(\"safety-btn\"),this.transitBtn=document.getElementById(\"transit-btn\"),this.autoRefreshBox=document.getElementById(\"auto-refresh\"),this.segmentTable=document.getElementById(\"segment-table-body\"),this.segmentNewBtn=document.getElementById(\"new-segment-btn\"),this.segmentEndBtn=document.getElementById(\"end-segment-btn\"),this.segmentEditBtn=document.getElementById(\"edit-segment-btn\"),this.refreshBtn=document.getElementById(\"refresh-btn\"),this.gpsMapConfig=document.getElementById(\"gps-map-config-icon\"),this.gpsMapBox=document.getElementById(\"gps-map-box\"),this.localMapBox=document.getElementById(\"local-map-box\"),this.mapInterface=new l(e),this.localMapInterface=new d(e),this.segmentInterface=new p(e),this.itoReasonInterface=new v(e),this.noteInterface=new y(e),this.imageInterface=new w(e),this.segmentList=[],this.itoReasonList=null,this.autoRefreshIntervalId=null,this.selectedRow=null,this.selectedRowId=null,this.selectedRowParentId=null,this.segmentTable.addEventListener(\"click\",this.segmentTableClickHandler.bind(this)),this.segmentTable.addEventListener(\"dblclick\",e=>{e.target.closest(\"tr\")!=this.selectedRow&&this.segmentTableClickHandler(e),this.editSegmentHandler()}),this.unexpectedBtn.addEventListener(\"click\",this.quickReasonEditBtnHandler.bind(this,12)),this.plannerBtn.addEventListener(\"click\",this.quickReasonEditBtnHandler.bind(this,3)),this.safetyBtn.addEventListener(\"click\",this.quickReasonEditBtnHandler.bind(this,1)),this.transitBtn.addEventListener(\"click\",this.quickReasonEditBtnHandler.bind(this,9)),this.segmentNewBtn.addEventListener(\"click\",this.newSegmentHandler.bind(this)),this.segmentEndBtn.addEventListener(\"click\",this.endSegmentHandler.bind(this)),this.segmentEditBtn.addEventListener(\"click\",this.editSegmentHandler.bind(this)),this.refreshBtn.addEventListener(\"click\",()=>{this.updateSegments()}),this.autoRefreshBox.addEventListener(\"change\",this.autoRefreshBoxHandler.bind(this)),this.gpsMapConfig.addEventListener(\"click\",this.gpsMapConfigHandler.bind(this)),this.gpsMapBox.addEventListener(\"click\",this.toggleGpsMapHandler.bind(this)),this.localMapBox.addEventListener(\"click\",this.toggleLocalMapHandler.bind(this))}async updateSegments(e=null){try{this.segmentList=e||await this.segmentInterface.get(this.legSelectHook.value);const t=Array.from(this.segmentTable.querySelectorAll(\"tr\"));for(const e of t.reverse()){this.segmentList.find(t=>t.id==e.firstChild.textContent)||(this.selectedRowId==e.firstChild.textContent&&(this.selectedRow=null,this.selectedRowId=null,this.selectedRowParentId=null,this.mapInterface.removeActiveMarker(),this.mapInterface.removeActivePoses(),this.localMapInterface.removeActiveMarker(),this.localMapInterface.removeActivePoses()),e.remove())}const s=this.mapInterface.mapPointsLayers,a=this.localMapInterface.mapPointsLayers;if(this.gpsMapBox.checked){for(let e=s.length-1;e>=0;e--){this.segmentList.find(t=>t.id==s[e].segmentId)||(this.mapInterface.leafletMap.removeLayer(s[e].mapPosesPtr),s.splice(e,1))}if(0==s.length){const e=this.segmentList.find(e=>e.lat&&e.lng);e&&(console.log(\"Setting map display in \"+e.lat+\", \"+e.lng),this.mapInterface.leafletMap.setView([e.lat,e.lng],17),this.mapInterface.removeLocalMap())}}if(this.localMapBox.checked){for(let e=a.length-1;e>=0;e--){this.segmentList.find(t=>t.id==a[e].segmentId)||this.localMapInterface.removePoses(a[e].segmentId)}0==a.length&&this.localMapInterface.resetViewer();const e=document.getElementById(\"shift-id\").value;if(e){const t=await this.localMapInterface.getAndDrawMap(e);if(this.gpsMapBox.checked&&t){let e=this.segmentList.filter(e=>e.lat&&e.lng&&e.local_x&&e.local_y&&null===e.parentId);e.length>=2&&(e.reverse(),await this.mapInterface.addLocalMap(t,e))}}else alert(\"No shift selected!\")}const n=0===a.length,i=0===s.length;for(const e of this.segmentList.reverse()){let r=e.id;if(\"ITO\"==e.segmentType&&!e.parentId){const t=this.segmentList.find(t=>t.parentId===e.id);t&&(r=t.id)}const l=t.find(e=>e.firstChild.textContent==r);if(\"AUTO\"==e.segmentType||\"ITO\"==e.segmentType&&e.parentId){const t=null==e.endTime?\"OPEN\":\"CLOSED\",s=e.itoReason||\"\";l?(l.children[2].textContent!=s&&(console.log(\"Updating row \"+e.id+\" reason\"),l.children[2].textContent=s),l.children[3].textContent!=t&&(console.log(\"Updating row \"+e.id+\" state\"),l.children[3].textContent=t)):(console.log(\"Creating row \"+e.id),h.a.addRow(this.segmentTable,[e.id,e.segmentType,s,t]))}if(this.gpsMapBox.checked&&!e.parentId){const t=s.find(t=>t.segmentId==e.id);(i||!t&&!l||null==e.endTime)&&(await this.mapInterface.getAndDrawMapPoses(e.id),(\"AUTO\"==e.segmentType&&e.id==this.selectedRowId||\"ITO\"==e.segmentType&&e.id==this.selectedRowParentId)&&this.mapInterface.addActivePoses(e.id))}if(this.localMapBox.checked&&!e.parentId){const t=a.find(t=>t.segmentId==e.id);(n||!t&&!l||null==e.endTime)&&(await this.localMapInterface.getAndDrawMapPoses(e.id),(\"AUTO\"==e.segmentType&&e.id==this.selectedRowId||\"ITO\"==e.segmentType&&e.id==this.selectedRowParentId)&&this.localMapInterface.addActivePoses(e.id))}}}catch(e){alert(e.message)}}autoRefreshBoxHandler(){this.autoRefreshBox.checked?this.legSelectHook.value?this.autoRefreshIntervalId=setInterval(()=>{this.updateSegments()},2e3):(this.autoRefreshBox.checked=!1,alert(\"No leg selected!\")):clearInterval(this.autoRefreshIntervalId)}segmentTableClickHandler(e){const t=e.target.closest(\"tr\");if(this.selectedRow&&(this.selectedRow.classList.remove(\"active-row\"),this.mapInterface.removeActiveMarker(),this.mapInterface.removeActivePoses(),this.localMapInterface.removeActiveMarker(),this.localMapInterface.removeActivePoses(),this.selectedRow==t))return this.selectedRow=null,this.selectedRowId=null,void(this.selectedRowParentId=null);this.selectedRow=t,this.selectedRowId=t.firstChild.textContent,this.selectedRow.classList.add(\"active-row\");const s=this.segmentList.find(e=>e.id==this.selectedRowId);if(this.selectedRowParentId=s.parentId,s.lat&&s.lng)this.mapInterface.addActiveMarker(s.lat,s.lng);else if(this.selectedRowParentId){const e=this.segmentList.find(e=>e.id==this.selectedRowParentId);e.lat&&e.lng&&this.mapInterface.addActiveMarker(e.lat,e.lng)}if(s.local_x&&s.local_y)this.localMapInterface.addActiveMarker(s.local_x,s.local_y);else if(this.selectedRowParentId){const e=this.segmentList.find(e=>e.id==this.selectedRowParentId);e.local_x&&e.local_y&&this.localMapInterface.addActiveMarker(e.local_x,e.local_y)}this.mapInterface.addActivePoses(this.selectedRowParentId||this.selectedRowId),this.localMapInterface.addActivePoses(this.selectedRowParentId||this.selectedRowId)}async quickReasonEditBtnHandler(e){if(!this.selectedRowId)return void alert(\"No segment selected for edition!\");if(\"AUTO\"!=this.segmentList.find(e=>e.id==this.selectedRowId).segmentType)try{await this.segmentInterface.put(this.selectedRowId,\"edit\",e),this.updateSegments()}catch(e){alert(e.message)}else alert(\"Cannot assign ITO reason to AUTO segment!\")}async newSegmentHandler(){try{if((!this.itoReasonList||0==this.itoReasonList.length)&&(this.itoReasonList=await this.itoReasonInterface.get(),0==this.itoReasonList.length))return void alert(\"ITO reasons list empty. Your database was not properly initialized. Please fix this before continuing.\")}catch(e){return void alert(e.message)}const e=this.itoReasonList.find(e=>\"Unassigned\"==e.shortDescription);let t;if(e){t=e.id;try{await this.segmentInterface.post(this.legSelectHook.value,t,1,null,null,null,null),this.updateSegments()}catch(e){alert(e.message)}}else alert(\"Unable to find the 'Unassigned' ITO reason. Your database was not properly initialized. Please fix this before continuing.\")}async endSegmentHandler(){if(this.selectedRowId)try{await this.segmentInterface.put(this.selectedRowId,\"close\"),this.updateSegments()}catch(e){alert(e.message)}else alert(\"No segment selected to end!\")}async editSegmentHandler(){if(this.selectedRowId)try{this.itoReasonList&&0!=this.itoReasonList.length||(this.itoReasonList=await this.itoReasonInterface.get());const e=this.segmentList.find(e=>e.id==this.selectedRowId),t=new b(e,this.segmentInterface,this.noteInterface,this.imageInterface,this.itoReasonList,this.currentUser);new m(t,\"Your browser does't support this feature! - Please change to a more modern one.\",()=>{this.updateSegments()}).show()}catch(e){alert(e.messaje)}else alert(\"Please select a segment to edit.\")}gpsMapConfigHandler(){const e=new E;new m(e,\"Your browser doesn't support this feature! - Please change to a more modern one.\",()=>{this.mapInterface.changeTileLayer()}).show()}toggleGpsMapHandler(e){if(e.target.checked)this.mapInterface.mapElement.style.display=\"block\",this.mapInterface.leafletMap.invalidateSize(!0),this.updateSegments();else{this.mapInterface.mapElement.style.display=\"none\";const e=this.mapInterface.mapPointsLayers;for(let t=e.length-1;t>=0;t--)this.mapInterface.leafletMap.removeLayer(e[t].mapPosesPtr),e.splice(t,1);this.mapInterface.removeLocalMap(),this.mapInterface.removeLayerControl()}}toggleLocalMapHandler(e){if(e.target.checked)this.localMapInterface.mapElement.style.display=\"block\",this.updateSegments();else{this.localMapInterface.mapElement.style.display=\"none\";const e=this.localMapInterface.mapPointsLayers;for(let t=e.length-1;t>=0;t--)this.localMapInterface.removePoses(e[t].segmentId),this.mapInterface.removeLocalMap(),this.mapInterface.removeLayerControl()}}}class B{constructor(e,t,s,a){this.fallbackText=s,this.visible=!1;const n=document.getElementById(\"confirmation-modal-template\"),i=document.importNode(n.content,!0);this.modalElement=i.querySelector(\".modal\"),this.modalElement.querySelector(\".modal__title\").firstElementChild.innerHTML=e,this.modalElement.querySelector(\"p\").innerHTML=t,this.modalElement.addEventListener(\"transitionend\",this.close.bind(this)),this.backdropElement=i.querySelector(\".backdrop\"),this.backdropElement.addEventListener(\"click\",this.hide.bind(this)),i.getElementById(\"modal-confirm-btn\").addEventListener(\"click\",()=>{a(),this.hide()}),i.getElementById(\"modal-cancel-btn\").addEventListener(\"click\",this.hide.bind(this))}show(){\"content\"in document.createElement(\"template\")?(document.body.insertAdjacentElement(\"afterbegin\",this.modalElement),document.body.insertAdjacentElement(\"afterbegin\",this.backdropElement),this.modalElement.scrollIntoView({behavior:\"smooth\"}),this.visible=!0,this.modalElement.classList.add(\"show\")):alert(this.fallbackText)}hide(){this.visible=!1,this.modalElement.classList.remove(\"show\")}close(){this.visible||this.modalElement&&(document.body.removeChild(this.modalElement),document.body.removeChild(this.backdropElement),this.modalElement=null,this.backdropElement=null)}}class S{constructor(e,t,s,a,n,i,r){this.id=e,this.startTime=t,this.endTime=s,this.location=a,this.version=n,this.timeZone=i,this.note=r}}class k{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"starttime_secs\",\"endtime_secs\",\"location\",\"version\",\"time_zone\",\"note\"]}async get(){return(await this.serverInterface.sendGetRequest(\"test_event\")).map(e=>new S(e[0],e[1],e[2],e[3],e[4],e[5],e[6]))}async post(e,t,s,a){const n={[this.paramNames[3]]:e,[this.paramNames[4]]:t,[this.paramNames[5]]:s,[this.paramNames[6]]:a};await this.serverInterface.sendPostRequest(\"test_event\",n)}async put(e,t,s=null,a=null,n=null,i=null){const r={[this.paramNames[0]]:e,action:t};Object.assign(r,null!==s&&{[this.paramNames[3]]:s},null!==a&&{[this.paramNames[4]]:a},null!==n&&{[this.paramNames[5]]:n},null!==i&&{[this.paramNames[6]]:i}),await this.serverInterface.sendPutRequest(\"test_event\",r)}async delete(e){await this.serverInterface.sendDeleteRequest(\"test_event\",\"id=\"+e)}}class x{constructor(e,t,s,a,n,i,r,l,o,c,d,h,m,u){this.id=e,this.testEventId=t,this.startTime=s,this.endTime=a,this.testAdministratorId=n,this.testDirectorId=i,this.safetyOfficerId=r,this.robotOperatorId=l,this.performerId=o,this.testIntent=c,this.workspace=d,this.vehicleId=h,this.note=m,this.number=u}}class T{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"test_event_id\",\"starttime_secs\",\"endtime_secs\",\"test_administrator_id\",\"test_director_id\",\"safety_officer_id\",\"robot_operator_id\",\"performer_id\",\"test_intent\",\"workspace\",\"vehicle_id\",\"note\",\"number\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"shift\",\"test_event_id=\"+e)).map(e=>new x(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13]))}async post(e,t,s,a,n,i,r,l,o,c){const d={[this.paramNames[1]]:e,[this.paramNames[4]]:t,[this.paramNames[5]]:s,[this.paramNames[6]]:a,[this.paramNames[7]]:n,[this.paramNames[8]]:i,[this.paramNames[9]]:r,[this.paramNames[10]]:l,[this.paramNames[11]]:o,[this.paramNames[12]]:c};await this.serverInterface.sendPostRequest(\"shift\",d)}async put(e,t,s=null,a=null,n=null,i=null,r=null,l=null,o=null,c=null,d=null){const h={[this.paramNames[0]]:e,action:t};Object.assign(h,null!==s&&{[this.paramNames[4]]:s},null!==a&&{[this.paramNames[5]]:a},null!==n&&{[this.paramNames[6]]:n},null!==i&&{[this.paramNames[7]]:i},null!==r&&{[this.paramNames[8]]:r},null!==l&&{[this.paramNames[9]]:l},null!==o&&{[this.paramNames[10]]:o},null!==c&&{[this.paramNames[11]]:c},null!==d&&{[this.paramNames[12]]:d}),await this.serverInterface.sendPutRequest(\"shift\",h)}async delete(e){await this.serverInterface.sendDeleteRequest(\"shift\",\"id=\"+e)}}class N{constructor(e,t,s,a,n,i,r,l){this.id=e,this.shiftId=t,this.startTime=s,this.endTime=a,this.weatherId=n,this.defaultPoseSourceId=i,this.note=r,this.number=l}}class M{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"shift_id\",\"starttime_secs\",\"endtime_secs\",\"weather_id\",\"default_pose_source_id\",\"note\",\"number\"]}async get(e){return(await this.serverInterface.sendGetRequest(\"leg\",\"shift_id=\"+e)).map(e=>new N(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]))}async post(e,t,s,a){const n={[this.paramNames[1]]:e,[this.paramNames[4]]:t,[this.paramNames[5]]:s,[this.paramNames[6]]:a};await this.serverInterface.sendPostRequest(\"leg\",n)}async put(e,t,s=null,a=null,n=null){const i={[this.paramNames[0]]:e,action:t};Object.assign(i,null!==s&&{[this.paramNames[4]]:s},null!==a&&{[this.paramNames[5]]:a},null!==n&&{[this.paramNames[6]]:n}),await this.serverInterface.sendPutRequest(\"leg\",i)}async delete(e){await this.serverInterface.sendDeleteRequest(\"leg\",\"id=\"+e)}}var _=s(3),D=s(1),H=s(4);class P{constructor(e,t){this.id=e,this.shortDescription=t}}class R{constructor(e){this.serverInterface=e,this.paramNames=[\"id\",\"short_description\"]}async get(){return(await this.serverInterface.sendGetRequest(\"weather\")).map(e=>new P(e[0],e[1]))}}var q=s(5);const O=[{label:\"(UTC-12:00)\",value:\"-12\"},{label:\"(UTC-11:00)\",value:\"-11\"},{label:\"(UTC-10:00)\",value:\"-10\"},{label:\"(UTC-09:00)\",value:\"-9\"},{label:\"(UTC-08:00)\",value:\"-8\"},{label:\"(UTC-07:00)\",value:\"-7\"},{label:\"(UTC-06:00)\",value:\"-6\"},{label:\"(UTC-05:00)\",value:\"-5\"},{label:\"(UTC-04:00)\",value:\"-4\"},{label:\"(UTC-03:30)\",value:\"-3.5\"},{label:\"(UTC-03:00)\",value:\"-3\"},{label:\"(UTC-02:00)\",value:\"-2\"},{label:\"(UTC-01:00)\",value:\"-1\"},{label:\"(UTC+00:00)\",value:\"0\"},{label:\"(UTC+01:00)\",value:\"1\"},{label:\"(UTC+02:00)\",value:\"2\"},{label:\"(UTC+03:00)\",value:\"3\"},{label:\"(UTC+03:30)\",value:\"3.5\"},{label:\"(UTC+04:00)\",value:\"4\"},{label:\"(UTC+04:30)\",value:\"4.5\"},{label:\"(UTC+05:00)\",value:\"5\"},{label:\"(UTC+05:30)\",value:\"5.5\"},{label:\"(UTC+05:45)\",value:\"5.75\"},{label:\"(UTC+06:00)\",value:\"6\"},{label:\"(UTC+06:30)\",value:\"6.5\"},{label:\"(UTC+07:00)\",value:\"7\"},{label:\"(UTC+08:00)\",value:\"8\"},{label:\"(UTC+09:00)\",value:\"9\"},{label:\"(UTC+09:30)\",value:\"9.5\"},{label:\"(UTC+10:00)\",value:\"10\"},{label:\"(UTC+11:00)\",value:\"11\"},{label:\"(UTC+12:00)\",value:\"12\"},{label:\"(UTC+13:00)\",value:\"13\"}];class U{constructor(e,t){this.testEvent=e,this.testEventInterface=t;const s=document.getElementById(\"edit-test-event-template\");this.element=document.importNode(s.content,!0),this.element.querySelector(\"header h2 span:last-of-type\").textContent=e.id,this.element.querySelector(\"header p:first-of-type span:last-of-type\").textContent=new Date(1e3*e.startTime).toISOString(),e.endTime&&(this.element.querySelector(\"header p:last-of-type span:last-of-type\").textContent=new Date(1e3*e.endTime).toISOString());const a=this.element.getElementById(\"location\"),n=this.element.getElementById(\"version\"),i=this.element.getElementById(\"time-zone\"),r=this.element.getElementById(\"test-event-note\"),l=O.map(e=>e.label);h.a.populateSelect(i,l);const o=l.findIndex(t=>t==e.timeZone);o>-1&&(i.value=l[o],h.a.removeFirstEmptyOption(i)),a.value=e.location,n.value=e.version,r.value=e.note,a.addEventListener(\"input\",this.testEventDataChangedHandler.bind(this)),n.addEventListener(\"input\",this.testEventDataChangedHandler.bind(this)),i.addEventListener(\"change\",this.testEventDataChangedHandler.bind(this)),r.addEventListener(\"input\",this.testEventDataChangedHandler.bind(this)),this.element.querySelector(\"form button\").addEventListener(\"click\",this.updateDataBtnHandler.bind(this))}testEventDataChangedHandler(){this.element.querySelector(\"form button\").disabled=!1}async updateDataBtnHandler(e){e.preventDefault();const t=document.getElementById(\"location\").value.replace(/[^\\x00-\\x7F]/g,\"\"),s=document.getElementById(\"version\").value.replace(/[^\\x00-\\x7F]/g,\"\"),a=document.getElementById(\"time-zone\").value,n=document.getElementById(\"test-event-note\").value.replace(/[^\\x00-\\x7F]/g,\"\");try{await this.testEventInterface.put(this.testEvent.id,\"edit\",t,s,a,n),this.element.querySelector(\"form button\").disabled=!0}catch(e){alert(e.message)}}}class A{constructor(e,t,s,a,n){this.shift=e,this.shiftInterface=t,this.performerList=s,this.personnelList=a,this.vehicleList=n;const i=document.getElementById(\"edit-shift-template\");this.element=document.importNode(i.content,!0),this.element.querySelector(\"header h2 span:last-of-type\").textContent=e.id,this.element.querySelector(\"header p:first-of-type span:last-of-type\").textContent=new Date(1e3*e.startTime).toISOString(),e.endTime&&(this.element.querySelector(\"header p:last-of-type span:last-of-type\").textContent=new Date(1e3*e.endTime).toISOString());const r=this.element.getElementById(\"performer\"),l=this.element.getElementById(\"test-director\"),o=this.element.getElementById(\"test-admin\"),c=this.element.getElementById(\"robot-operator\"),d=this.element.getElementById(\"safety-officer\"),m=this.element.getElementById(\"test-intent\"),u=this.element.getElementById(\"workspace\"),p=this.element.getElementById(\"vehicle\"),g=this.element.getElementById(\"shift-note\");h.a.populateSelect(r,s.map(e=>e.institution)),h.a.populateSelect(l,a.map(e=>e.name)),h.a.populateSelect(o,a.map(e=>e.name)),h.a.populateSelect(c,a.map(e=>e.name)),h.a.populateSelect(d,a.map(e=>e.name)),h.a.populateSelect(p,n.map(e=>e.shortDescription));const v=s.find(t=>t.id==e.performerId);v&&(r.value=v.institution,h.a.removeFirstEmptyOption(r));const f=a.find(t=>t.id==e.testDirectorId);f&&(l.value=f.name,h.a.removeFirstEmptyOption(l));const y=a.find(t=>t.id==e.testAdministratorId);y&&(o.value=y.name,h.a.removeFirstEmptyOption(o));const I=a.find(t=>t.id==e.robotOperatorId);I&&(c.value=I.name,h.a.removeFirstEmptyOption(c));const w=a.find(t=>t.id==e.safetyOfficerId);w&&(d.value=w.name,h.a.removeFirstEmptyOption(d));const b=n.find(t=>t.id==e.vehicleId);b&&(p.value=b.shortDescription,h.a.removeFirstEmptyOption(p)),m.value=e.testIntent,u.value=e.workspace,g.value=e.note,r.addEventListener(\"change\",this.shiftDataChangedHandler.bind(this)),l.addEventListener(\"change\",this.shiftDataChangedHandler.bind(this)),o.addEventListener(\"change\",this.shiftDataChangedHandler.bind(this)),c.addEventListener(\"change\",this.shiftDataChangedHandler.bind(this)),d.addEventListener(\"change\",this.shiftDataChangedHandler.bind(this)),m.addEventListener(\"input\",this.shiftDataChangedHandler.bind(this)),u.addEventListener(\"input\",this.shiftDataChangedHandler.bind(this)),p.addEventListener(\"change\",this.shiftDataChangedHandler.bind(this)),g.addEventListener(\"input\",this.shiftDataChangedHandler.bind(this)),this.element.querySelector(\"form button\").addEventListener(\"click\",this.updateDataBtnHandler.bind(this))}shiftDataChangedHandler(){this.element.querySelector(\"form button\").disabled=!1}async updateDataBtnHandler(e){e.preventDefault();const t=this.personnelList.find(e=>e.name==document.getElementById(\"test-admin\").value).id,s=this.personnelList.find(e=>e.name==document.getElementById(\"test-director\").value).id,a=this.personnelList.find(e=>e.name==document.getElementById(\"safety-officer\").value).id,n=this.personnelList.find(e=>e.name==document.getElementById(\"robot-operator\").value).id,i=this.performerList.find(e=>e.institution==document.getElementById(\"performer\").value).id,r=document.getElementById(\"test-intent\").value.replace(/[^\\x00-\\x7F]/g,\"\"),l=document.getElementById(\"workspace\").value.replace(/[^\\x00-\\x7F]/g,\"\"),o=this.vehicleList.find(e=>e.shortDescription==document.getElementById(\"vehicle\").value).id,c=document.getElementById(\"shift-note\").value.replace(/[^\\x00-\\x7F]/g,\"\");try{await this.shiftInterface.put(this.shift.id,\"edit\",t,s,a,n,i,r,l,o,c),this.element.querySelector(\"form button\").disabled=!0}catch(e){alert(e.message)}}}class F{constructor(e,t,s,a){this.leg=e,this.legInterface=t,this.weatherList=s,this.poseSourceList=a;const n=document.getElementById(\"edit-leg-template\");this.element=document.importNode(n.content,!0),this.element.querySelector(\"header h2 span:last-of-type\").textContent=e.id,this.element.querySelector(\"header p:first-of-type span:last-of-type\").textContent=new Date(1e3*e.startTime).toISOString(),e.endTime&&(this.element.querySelector(\"header p:last-of-type span:last-of-type\").textContent=new Date(1e3*e.endTime).toISOString());const i=this.element.getElementById(\"weather\"),r=this.element.getElementById(\"default-pose-source\"),l=this.element.getElementById(\"leg-note\");h.a.populateSelect(i,s.map(e=>e.shortDescription)),h.a.populateSelect(r,a.map(e=>e.shortDescription));const o=s.find(t=>t.id==e.weatherId);o&&(i.value=o.shortDescription,h.a.removeFirstEmptyOption(i));const c=a.find(t=>t.id==e.defaultPoseSourceId);c&&(r.value=c.shortDescription,h.a.removeFirstEmptyOption(r)),l.value=e.note,i.addEventListener(\"change\",this.legDataChangedHandler.bind(this)),r.addEventListener(\"change\",this.legDataChangedHandler.bind(this)),l.addEventListener(\"input\",this.legDataChangedHandler.bind(this)),this.element.querySelector(\"form button\").addEventListener(\"click\",this.updateDataBtnHandler.bind(this))}legDataChangedHandler(){this.element.querySelector(\"form button\").disabled=!1}async updateDataBtnHandler(e){e.preventDefault();const t=this.weatherList.find(e=>e.shortDescription==document.getElementById(\"weather\").value).id,s=this.poseSourceList.find(e=>e.shortDescription==document.getElementById(\"default-pose-source\").value).id,a=document.getElementById(\"leg-note\").value.replace(/[^\\x00-\\x7F]/g,\"\");try{await this.legInterface.put(this.leg.id,\"edit\",t,s,a),this.element.querySelector(\"form button\").disabled=!0}catch(e){alert(e.message)}}}class j{constructor(e,t,s=null,a=null,n){this.name=e,this.dataInterface=t,this.parentSelect=s,this.childClass=a,this.checkSelectionFcn=n,this.select=document.getElementById(e+\"-id\"),this.newBtn=document.getElementById(`new-${e}-btn`),this.endBtn=document.getElementById(`end-${e}-btn`),this.editBtn=document.getElementById(`edit-${e}-btn`),this.deleteBtn=document.getElementById(`delete-${e}-btn`),this.postData=null,this.dataList=[],this.open=!1,this.select.addEventListener(\"change\",this.selectChangeHandler.bind(this)),this.newBtn.addEventListener(\"click\",this.newBtnClickHandler.bind(this)),this.endBtn.addEventListener(\"click\",this.endBtnClickHandler.bind(this)),this.editBtn.addEventListener(\"click\",this.editBtnClickHandler.bind(this)),this.deleteBtn.addEventListener(\"click\",this.deleteBtnClickHandler.bind(this))}checkSelectionCallback(){this.checkSelectionFcn()}clearSelectData(){this.childClass&&this.childClass.clearSelectData(),h.a.clearChildren(this.select)}async updateData(){this.dataList=await this.dataInterface.get(this.parentSelect&&this.parentSelect.value)}async updateSelect(){if(!this.parentSelect||this.parentSelect.value)try{await this.updateData(),h.a.populateSelect(this.select,this.dataList.map(e=>e.id).reverse(),this.dataList.map(e=>e.endTime?\"closed-log\":\"open-log\").reverse()),this.childClass&&this.childClass.clearSelectData()}catch(e){alert(e.message)}else alert(\"Please select an ID in the parent select first.\")}async selectChangeHandler(){h.a.removeFirstEmptyOption(this.select),this.open=!this.dataList.find(e=>e.id==this.select.value).endTime,this.childClass&&await this.childClass.updateSelect(),this.childClass&&1===this.childClass.dataList.length?(this.childClass.select.value=this.childClass.dataList[0].id,this.childClass.selectChangeHandler()):this.checkSelectionCallback()}async newBtnClickHandler(){try{await this.dataInterface.post(...this.postData),await this.updateSelect(),h.a.removeFirstEmptyOption(this.select),this.select.value=Math.max(...this.dataList.map(e=>e.id)),this.open=!0,await this.editBtnClickHandler(),this.checkSelectionCallback()}catch(e){alert(e.message)}}async recursiveUpdate(){this.childClass&&await this.childClass.recursiveUpdate(),(!this.parentSelect||this.parentSelect&&this.parentSelect.value)&&(await this.updateData(),this.select.value&&(this.open=!this.dataList.find(e=>e.id==this.select.value).endTime),Array.from(this.select.children).forEach(e=>{if(e.value){const t=this.dataList.find(t=>t.id==e.value);e.className=t.endTime?\"closed-log\":\"open-log\"}}))}async endBtnClickHandler(){if(this.select.value)try{await this.dataInterface.put(this.select.value,\"close\"),await this.recursiveUpdate(),this.checkSelectionCallback()}catch(e){alert(e.message)}else alert(\"Please select an ID to close.\")}async editBtnClickHandler(){new m(this.editContainer,\"Your browser does't support this feature! - Please change to a more modern one.\",this.updateData.bind(this)).show()}async deleteLogEntry(){try{await this.dataInterface.delete(this.select.value),await this.updateSelect(),this.open=!1,this.checkSelectionCallback()}catch(e){alert(e.message)}}async deleteBtnClickHandler(){if(!this.select.value)return void alert(\"Please select an ID to delete!\");new B(\"Warning!\",`<strong>This operation cannot be undone!</strong>\\n      Are you sure you want to delete <b>${this.name.replace(/-/g,\" \")} ${this.select.value}</b> and all its children?`,\"Your browser does't support this feature! - Please change to a more modern one.\",this.deleteLogEntry.bind(this)).show()}}class z extends j{constructor(e,t,s){super(\"test-event\",new k(e),null,t,s),this.openBtn=document.getElementById(\"open-test-event-btn\"),this.openBtn.addEventListener(\"click\",this.openBtnClickHandler.bind(this))}checkSelectionCallback(){super.checkSelectionCallback(),this.open?(this.endBtn.style.display=\"grid\",this.openBtn.style.display=\"none\"):(this.endBtn.style.display=\"none\",this.openBtn.style.display=\"grid\")}async newBtnClickHandler(){this.postData=[null,null,null,null],await super.newBtnClickHandler()}async openBtnClickHandler(){if(this.select.value)try{await this.dataInterface.put(this.select.value,\"open\"),await this.recursiveUpdate(),this.checkSelectionCallback()}catch(e){alert(e.message)}else alert(\"Please select an ID to open.\")}async editBtnClickHandler(){if(!this.select.value)return void alert(\"Please select an ID to edit.\");const e=this.dataList.find(e=>e.id==this.select.value);this.editContainer=new U(e,this.dataInterface),await super.editBtnClickHandler()}}class Y extends j{constructor(e,t,s,a){super(\"shift\",new T(e),document.getElementById(\"test-event-id\"),t,s),this.currentUser=a,this.performerInterface=new _.a(e),this.personnelInterface=new D.b(e),this.vehicleInterface=new H.a(e),this.performerList=null,this.personnelList=null,this.vehicleList=null}async newBtnClickHandler(){if(!this.parentSelect.value)return void alert(\"Please select a test event to add a new shift!\");if(!this.currentUser.id)return void document.getElementById(\"user-icon\").click();try{this.performerList=await this.performerInterface.get(),this.vehicleList=await this.vehicleInterface.get()}catch(e){return void alert(e.message)}if(0==this.performerList.length||0==this.vehicleList.length)return void alert(\"Please configure a performer and a vehicle before trying to add a new shift!\");let e=this.performerList.find(e=>e.institution==this.currentUser.institution)||this.performerList[0],t=this.vehicleList.find(e=>e.institution==this.currentUser.institution)||this.vehicleList[0];this.postData=[this.parentSelect.value,this.currentUser.id,this.currentUser.id,this.currentUser.id,this.currentUser.id,e.id,null,null,t.id,null],await super.newBtnClickHandler()}async editBtnClickHandler(){if(!this.select.value)return void alert(\"Please select an ID to edit.\");const e=this.dataList.find(e=>e.id==this.select.value);try{this.performerList=await this.performerInterface.get(),this.personnelList=await this.personnelInterface.get(),this.vehicleList=await this.vehicleInterface.get()}catch(e){return void alert(e.message)}this.editContainer=new A(e,this.dataInterface,this.performerList,this.personnelList,this.vehicleList),await super.editBtnClickHandler()}}class $ extends j{constructor(e,t){super(\"leg\",new M(e),document.getElementById(\"shift-id\"),null,t),this.weatherInterface=new R(e),this.poseSourceInterface=new q.a(e),this.weatherList=null,this.poseSourceList=null}async newBtnClickHandler(){if(this.parentSelect.value){try{this.weatherList&&0!=this.weatherList.length||(this.weatherList=await this.weatherInterface.get()),this.poseSourceList=await this.poseSourceInterface.get()}catch(e){return void alert(e.message)}0!=this.weatherList.length?0!=this.poseSourceList.length?(this.postData=[this.parentSelect.value,this.weatherList[0].id,this.poseSourceList[0].id,null],await super.newBtnClickHandler()):alert(\"Please configure a pose source before trying to add a new leg!\"):alert(\"Weather list empty. Your database was not properly initialized. Please fix this before continuing.\")}else alert(\"Please select a shift to add a new leg!\")}async editBtnClickHandler(){if(!this.select.value)return void alert(\"Please select an ID to edit.\");const e=this.dataList.find(e=>e.id==this.select.value);try{this.weatherList&&0!=this.weatherList.length||(this.weatherList=await this.weatherInterface.get()),this.poseSourceList=await this.poseSourceInterface.get()}catch(e){return void alert(e.message)}this.editContainer=new F(e,this.dataInterface,this.weatherList,this.poseSourceList),await super.editBtnClickHandler()}}class G{constructor(e,t,s,a){this.ros=t,this.doneCallback=a,this.startLoggingBtn=document.getElementById(\"start-logging-btn\"),this.isLogging=!1,this.setLoggingClient=new ROSLIB.Service({ros:this.ros,name:\"/set_ftt_logging\",serviceType:\"std_srvs/SetBool\"}),this.getLoggingClient=new ROSLIB.Service({ros:this.ros,name:\"/get_ftt_logging\",serviceType:\"std_srvs/Trigger\"}),this.legLog=new $(e,this.checkSelectedLogs.bind(this)),this.shiftLog=new Y(e,this.legLog,this.checkSelectedLogs.bind(this),s),this.testEventLog=new z(e,this.shiftLog,this.checkSelectedLogs.bind(this)),this.startLoggingBtn.addEventListener(\"click\",this.loggingBtnClickHandler.bind(this)),this.init()}async init(){await this.testEventLog.updateSelect();if((await this.shiftLog.personnelInterface.get()).length>0)document.getElementById(\"user-icon\").click();else{new B(\"Welcome!\",\"It looks like you haven't configured any users yet. \\n        Please input at least one entry for each <strong>Database Configuration</strong> table. \\n        Clicking on the top left cogwheel of the main page or on the <i>confirm</i> button below will take you to the configuration page.\",\"Your browser does't support this feature! - Please change to a more modern one.\",()=>{document.getElementById(\"config-icon\").click()}).show()}}toggleLogging(){this.isLogging=!this.isLogging,this.isLogging?this.startLoggingBtn.textContent=\"Stop Logging\":this.startLoggingBtn.textContent=\"Start Logging\"}updateLogging(){if(this.ros.isConnected){const e=new ROSLIB.ServiceRequest;this.getLoggingClient.callService(e,e=>{e.success!=this.isLogging&&this.toggleLogging(),this.testEventLog.open&&this.shiftLog.open&&this.legLog.open||this.isLogging?this.startLoggingBtn.disabled=!1:this.startLoggingBtn.disabled=!0})}else this.startLoggingBtn.disabled=!0}loggingBtnClickHandler(){const e=new ROSLIB.ServiceRequest({data:!this.isLogging});this.setLoggingClient.callService(e,e=>{e.success?(this.doneCallback(),this.updateLogging()):alert(e.message)})}checkSelectedLogs(){document.getElementById(\"segment-detail\").style.display=\"none\",document.getElementById(\"map-viewer\").style.display=\"none\",this.testEventLog.select.value&&this.shiftLog.select.value&&this.legLog.select.value?(this.doneCallback(),this.updateLogging()):this.startLoggingBtn.disabled=!0;const e=document.getElementById(\"auto-refresh\");e.checked&&e.click();const t=document.getElementById(\"gps-map-box\");t.checked&&t.click();const s=document.getElementById(\"local-map-box\");s.checked&&s.click()}}class Z{constructor(e,t){this.currentUser=e,this.personnelList=t;const s=document.getElementById(\"select-user-template\");this.element=document.importNode(s.content,!0);const a=this.element.getElementById(\"user\");h.a.populateSelect(a,t.map(e=>`${e.id}.- ${e.name} - ${e.institution}`));const n=t.findIndex(t=>t.id==e.id);n>-1&&(h.a.removeFirstEmptyOption(a),a.value=a.children[n].value),a.addEventListener(\"change\",this.userChangedHandler.bind(this))}userChangedHandler(){const e=document.getElementById(\"user\").value;Object.assign(this.currentUser,this.personnelList.find(t=>e.includes(t.name))),document.getElementById(\"modal-close-btn\").click()}}class V{constructor(e,t){this.serverInterface=e;const s=document.getElementById(\"report-download-template\");this.element=document.importNode(s.content,!0);const a=this.element.getElementById(\"report-test-event-id\"),n=this.element.querySelector(\"form\");h.a.populateSelect(a,t.filter(e=>!!e.endTime).map(e=>e.id+\": \"+new Date(1e3*e.startTime).toISOString().split(\"T\")[0]+\"-\"+(e.location||\"(no location)\")).reverse()),n.querySelector(\"button\").addEventListener(\"click\",this.generateReportBtnHandler.bind(this)),n.querySelectorAll(\"select\").forEach(e=>{e.addEventListener(\"change\",this.formChangedHandler.bind(this))}),n.addEventListener(\"input\",this.formChangedHandler.bind(this)),n.querySelectorAll(\"textarea\").forEach(e=>{e.addEventListener(\"input\",this.checkTextareas.bind(this))}),this.checkTextareas()}checkTextareas(){this.element.querySelectorAll(\"form textarea\").forEach(e=>{e.value.match(/[^\\x00-\\x7F]/g)?e.classList.add(\"error\"):e.classList.remove(\"error\")})}formChangedHandler(){this.element.querySelector(\"form button:last-of-type\").disabled=!0;const e=this.element.querySelector(\"form button:first-of-type\");document.getElementById(\"report-tile-server\").value&&document.getElementById(\"report-zoom-level\").value.replace(/[^0-9]/g,\"\")&&document.getElementById(\"report-name\").value.replace(/[^\\x00-\\x7F]/g,\"\")&&document.getElementById(\"report-version\").value.replace(/[^\\x00-\\x7F]/g,\"\")&&document.getElementById(\"report-test-event-id\").value&&document.getElementById(\"report-min-duration\").value.replace(/[^0-9.]/g,\"\")&&document.getElementById(\"report-use-local-poses\").value&&document.getElementById(\"report-recipient-name\").value.replace(/[^\\x00-\\x7F]/g,\"\")&&document.getElementById(\"report-recipient-address\").value.replace(/[^\\x00-\\x7F]/g,\"\")&&document.getElementById(\"report-creator-name\").value.replace(/[^\\x00-\\x7F]/g,\"\")&&document.getElementById(\"report-creator-address\").value.replace(/[^\\x00-\\x7F]/g,\"\")?e.disabled=!1:e.disabled=!0}async generateReportBtnHandler(e){e.preventDefault();const t=document.getElementById(\"report-tile-server\").value,s=document.getElementById(\"report-zoom-level\").value.replace(/[^0-9]/g,\"\"),a=document.getElementById(\"report-name\").value.replace(/[^\\x00-\\x7F]/g,\"\"),n=document.getElementById(\"report-version\").value.replace(/[^\\x00-\\x7F]/g,\"\"),i=document.getElementById(\"report-test-event-id\").value.split(\":\")[0],r=document.getElementById(\"report-min-duration\").value.replace(/[^0-9.]/g,\"\"),l=document.getElementById(\"report-use-local-poses\").value,o=document.getElementById(\"report-recipient-name\").value.replace(/[^\\x00-\\x7F]/g,\"\"),c=document.getElementById(\"report-recipient-address\").value.replace(/[^\\x00-\\x7F]/g,\"\"),d=document.getElementById(\"report-creator-name\").value.replace(/[^\\x00-\\x7F]/g,\"\"),h=document.getElementById(\"report-creator-address\").value.replace(/[^\\x00-\\x7F]/g,\"\"),m=this.element.querySelector(\"form button:first-of-type i\");m.style.display=\"block\";try{const e={tile_server:t,zoom_level:s,report_name:a,report_version:n,test_event_id:i,min_duration:r,use_local_poses:l,recipient_name:o,recipient_address:c,creator_name:d,creator_address:h};await this.serverInterface.sendPostRequest(\"generate_report\",e),this.element.querySelector(\"form button:last-of-type\").disabled=!1}catch(e){alert(e.message)}m.style.display=\"none\"}}class X{constructor(e){this.serverInterface=e,this.userIcon=document.getElementById(\"user-icon\"),this.userName=document.getElementById(\"user-name\"),this.downloadIcon=document.getElementById(\"download-icon\"),this.rosConnectIcon=document.getElementById(\"ros-status-light\"),this.currentUser=new D.a,this.personnelInterface=new D.b(this.serverInterface),this.testEventInterface=new k(this.serverInterface),this.openLogsSelected=!1,this.ros=new ROSLIB.Ros,this.rosConnectIntervalId=null,this.forceRosConnect=!1,this.ros_server_adr=`ws://${location.hostname}:9090`,this.segmentDetail=new C(e,this.currentUser),this.logSelection=new G(e,this.ros,this.currentUser,this.logSelectionDoneCallback.bind(this)),this.userIcon.addEventListener(\"click\",this.userIconClickHandler.bind(this)),this.downloadIcon.addEventListener(\"click\",this.downloadIconClickHandler.bind(this)),this.rosConnectIcon.addEventListener(\"click\",this.rosConnectIconClickHandler.bind(this)),this.ros.on(\"error\",this.rosErrorHandler.bind(this)),this.ros.on(\"connection\",this.rosConnectionHandler.bind(this)),this.ros.on(\"close\",this.rosCloseHandler.bind(this)),this.rosConnect()}async logSelectionDoneCallback(){document.getElementById(\"segment-detail\").style.display=\"block\",document.getElementById(\"map-viewer\").style.display=\"block\";const e=await this.segmentDetail.segmentInterface.get(this.segmentDetail.legSelectHook.value);for(const t of e)if(t.lng&&t.lat&&!this.segmentDetail.gpsMapBox.checked){this.segmentDetail.gpsMapBox.checked=!0,this.segmentDetail.mapInterface.mapElement.style.display=\"block\",this.segmentDetail.mapInterface.leafletMap.invalidateSize(!0);break}for(const t of e)if(t.local_x&&t.local_y&&!this.segmentDetail.localMapBox.checked){this.segmentDetail.localMapBox.checked=!0,this.segmentDetail.localMapInterface.mapElement.style.display=\"block\";break}this.segmentDetail.updateSegments(e)}async userIconClickHandler(){try{const e=await this.personnelInterface.get(),t=new Z(this.currentUser,e);new m(t,\"Your browser doesn't support this feature! - Please change to a more modern one.\",()=>{this.userName.textContent=this.currentUser.name||\"Select User\"}).show()}catch(e){alert(e.message)}}async downloadIconClickHandler(){try{const e=await this.testEventInterface.get(),t=new V(this.serverInterface,e);new m(t,\"Your browser doesn't support this feature! - Please change to a more modern one.\").show()}catch(e){alert(e.message)}}rosConnectIconClickHandler(){this.forceRosConnect=!0,this.rosConnect()}rosConnect(){this.ros.connect(this.ros_server_adr)}rosErrorHandler(){this.logSelection.updateLogging();const e=\"Error connecting to ROS. Make sure rosbridge_server is running.\";console.log(e),this.forceRosConnect&&(alert(e),this.forceRosConnect=!1)}rosConnectionHandler(){this.logSelection.updateLogging(),this.rosConnectIcon.classList.remove(\"disconnected\"),this.rosConnectIcon.classList.add(\"connected\"),this.rosConnectIcon.textContent=\"sensors\",console.log(\"Connection to ROS established.\")}rosCloseHandler(){this.logSelection.updateLogging(),this.rosConnectIcon.classList.remove(\"connected\"),this.rosConnectIcon.classList.add(\"disconnected\"),this.rosConnectIcon.textContent=\"sensors_off\",console.log(\"Connection to ROS closed.\")}}(class{static init(){this.serverInterface=new a.a,this.mainFrame=new X(this.serverInterface)}}).init()}]);"],"mappings":"AAAA","sourceRoot":""}